---
import BlogLayout from '../../layouts/BlogLayout.astro';
import LikeButton from '../../components/blog/LikeButton';
import RelatedPosts from '../../components/blog/RelatedPosts';
import TableOfContents from '../../components/blog/TableOfContents.astro';
import AISummaryTrigger from '../../components/blog/ai-summary/AISummaryTrigger';
import AISummaryContent from '../../components/blog/ai-summary/AISummaryContent';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const {
  title,
  description,
  publishedDate,
  updatedDate,
  author,
  image,
  imageAlt,
  tags,
  keywords,
  readTime,
  aiSummary,
} = post.data;

// Get image source
const imageSrc = typeof image === 'string' ? image : image.src;

// Format dates
const formattedDate = new Intl.DateTimeFormat('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
}).format(publishedDate);

const formattedUpdateDate = updatedDate
  ? new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    }).format(updatedDate)
  : null;

// Get related posts (posts with shared tags, excluding current)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug)
  .filter((p) => p.data.tags.some((tag) => tags.includes(tag)))
  .sort((a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf())
  .slice(0, 3);

// Structured data for SEO
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: new URL(imageSrc, Astro.site).href,
  datePublished: publishedDate.toISOString(),
  dateModified: (updatedDate || publishedDate).toISOString(),
  author: {
    '@type': 'Person',
    name: author.name,
    url: 'https://dinilr.com',
  },
  publisher: {
    '@type': 'Person',
    name: 'Hirusha Dinil Rubasinghe',
    logo: {
      '@type': 'ImageObject',
      url: 'https://dinilr.com/logo.svg',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://dinilr.com/blog/${post.slug}`,
  },
  keywords: keywords ? keywords.join(', ') : tags.join(', '),
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: 'https://dinilr.com',
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Blog',
      item: 'https://dinilr.com/blog',
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: title,
      item: `https://dinilr.com/blog/${post.slug}`,
    },
  ],
};
---

<BlogLayout
  title={`${title} | Blog | Hirusha Dinil`}
  description={description}
  ogImage={imageSrc}
>
  <!-- Structured Data -->
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(articleSchema)}
    slot="head"
  />
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(breadcrumbSchema)}
    slot="head"
  />

  <article class="pb-16">
    <!-- Hero Image -->
    <div class="absolute top-0 left-0 w-full h-[55vh] md:h-[65vh] z-0 overflow-hidden">
      <img
        src={imageSrc}
        alt={imageAlt}
        class="w-full h-full object-cover scale-105"
      />
      <!-- Refined gradient overlays -->
      <!-- Top gradient for navbar visibility -->
      <div class="absolute inset-x-0 top-0 h-48 bg-gradient-to-b from-[#0c0c0c] via-[#0c0c0c]/70 to-transparent z-10"></div>
      <!-- Bottom gradient for text readability -->
      <div class="absolute inset-0 bg-gradient-to-b from-transparent via-[#0c0c0c]/60 to-[#0c0c0c]"></div>
      <div class="absolute inset-0 bg-[#0c0c0c]/20"></div>
    </div>

    <!-- Spacer -->
    <div class="h-[40vh] md:h-[50vh]"></div>

    <!-- Article Header -->
    <header class="max-w-3xl mx-auto px-6 relative z-10">
      <!-- Meta row: date + read time -->
      <div class="flex items-center gap-3 text-sm text-theme-text-muted mb-4">
        <time datetime={publishedDate.toISOString()}>
          {formattedDate}
        </time>
        {readTime && (
          <>
            <span class="w-1 h-1 rounded-full bg-theme-text-muted/50"></span>
            <span>{readTime} min read</span>
          </>
        )}
        {formattedUpdateDate && (
          <>
            <span class="w-1 h-1 rounded-full bg-theme-text-muted/50"></span>
            <span class="text-xs">Updated {formattedUpdateDate}</span>
          </>
        )}
      </div>

      <!-- Title -->
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-medium text-theme-text-primary mb-5 leading-[1.15] tracking-tight">
        {title}
      </h1>

      <!-- Tags -->
      <div class="flex flex-wrap gap-2 mb-6">
        {tags.slice(0, 4).map((tag) => (
          <a
            href={`/blog?tag=${encodeURIComponent(tag)}`}
            class="text-xs px-2.5 py-1 text-theme-text-muted hover:text-theme-text-secondary transition-colors duration-200 border-b border-transparent hover:border-theme-border-muted"
          >
            #{tag}
          </a>
        ))}
      </div>

      <!-- Author -->
      <div class="flex items-center justify-between pt-4 border-t border-theme-border-muted/50">
        <div class="flex items-center gap-3">
          {author.avatar && (
            <img
              src={author.avatar}
              alt={author.name}
              class="w-9 h-9 rounded-full object-cover grayscale opacity-80"
            />
          )}
          <div>
            <span class="text-sm font-medium text-theme-text-primary">{author.name}</span>
          </div>
        </div>
        
        {/* AI Summary Trigger */}
        {aiSummary && <AISummaryTrigger client:visible />}
      </div>
    </header>

    <!-- Article Content -->
    <div class="max-w-3xl mx-auto px-6 mt-12 relative z-10">
      {/* AI Summary Section */}
      {/* AI Summary Content */}
      {aiSummary && (
        <AISummaryContent client:load summary={aiSummary} />
      )}

      <div class="prose prose-lg">
        <TableOfContents headings={headings} />
        <Content />
      </div>

      <!-- Article Footer -->
      <footer class="mt-16 pt-8 border-t border-theme-border-muted/50">
        <!-- Like & Share Row -->
        <div class="flex items-center justify-between flex-wrap gap-6">
          <LikeButton client:visible postSlug={post.slug} />

          <!-- Share Links -->
          <div class="flex items-center gap-1">
            <span class="text-xs text-theme-text-muted mr-2 uppercase tracking-wider">Share</span>
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(`https://dinilr.com/blog/${post.slug}`)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="p-2.5 text-theme-text-muted hover:text-theme-text-primary hover:brightness-150 transition-all duration-300"
              aria-label="Share on X"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path>
              </svg>
            </a>
            <a
              href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(`https://dinilr.com/blog/${post.slug}`)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="p-2.5 text-theme-text-muted hover:text-theme-text-primary hover:brightness-150 transition-all duration-300"
              aria-label="Share on LinkedIn"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path>
              </svg>
            </a>
            <div class="relative">
              <button
                id="copy-link-btn"
                class="p-2.5 text-theme-text-muted hover:text-theme-text-primary hover:brightness-150 transition-all duration-300"
                aria-label="Copy link"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                </svg>
              </button>
              <span
                id="copy-tooltip"
                class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 text-xs text-theme-text-primary bg-theme-bg-secondary border border-theme-border-muted rounded opacity-0 pointer-events-none transition-opacity duration-200 whitespace-nowrap"
              >
                Copied!
              </span>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="max-w-5xl mx-auto px-6 mt-24 pt-12 border-t border-theme-border-muted/30 relative z-10">
        <h2 class="text-xs font-medium text-theme-text-muted uppercase tracking-widest mb-8">
          Continue Reading
        </h2>
        <RelatedPosts client:visible posts={relatedPosts} />
      </section>
    )}

    <!-- Back to Blog -->
    <nav class="max-w-3xl mx-auto px-6 mt-16 relative z-10">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-sm text-theme-text-muted hover:text-theme-text-primary transition-colors group"
      >
        <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
        </svg>
        All posts
      </a>
    </nav>
  </article>
</BlogLayout>

<script>
  document.addEventListener('astro:page-load', () => {
    const copyBtn = document.getElementById('copy-link-btn');
    const tooltip = document.getElementById('copy-tooltip');
    let timeoutId: ReturnType<typeof setTimeout>;

    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        
        if (timeoutId) clearTimeout(timeoutId);
        
        tooltip?.classList.remove('opacity-0');
        tooltip?.classList.add('opacity-100');
        
        timeoutId = setTimeout(() => {
          tooltip?.classList.remove('opacity-100');
          tooltip?.classList.add('opacity-0');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy link:', err);
      }
    });
  });
</script>
